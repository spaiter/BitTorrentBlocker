# Dockerfile for running XDP integration tests
# Requires: --privileged --network host (for network interface access)
# Usage: docker build -f Dockerfile.xdp-test -t btblocker-xdp-test .
#        docker run --rm --privileged --network host -v ${PWD}:/src btblocker-xdp-test

FROM golang:1.25-bookworm

# Install dependencies for XDP testing
RUN apt-get update && apt-get install -y \
    iproute2 \
    iputils-ping \
    net-tools \
    libpcap-dev \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /src

# Copy go.mod and go.sum first (for caching)
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build the project to ensure everything compiles
RUN go build -o /tmp/btblocker ./cmd/btblocker

# Run integration tests with verbose output
CMD ["go", "test", "-v", "-tags", "linux,integration", "-timeout", "5m", "./test/integration/..."]
