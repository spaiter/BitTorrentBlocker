name: Nix Maintenance

on:
  push:
    branches: [ main ]

jobs:
  update-flake:
    name: Update Flake Lock
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update flake inputs
        run: |
          nix flake update --commit-lock-file || {
            # If commit-lock-file fails, do it manually
            nix flake update
            if ! git diff --quiet flake.lock; then
              git add flake.lock
              git commit -m "chore: update flake.lock" -m "ðŸ¤– Generated by GitHub Actions"
            fi
          }

      - name: Push changes
        run: |
          git push || echo "No changes to push"
