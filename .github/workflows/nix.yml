name: Nix Build

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build Nix Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: btblocker
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: ${{ github.event_name == 'pull_request' }}

      - name: Check Nix flake
        run: nix flake check --print-build-logs

      - name: Build btblocker package
        run: |
          nix build .#btblocker --print-build-logs

      - name: Push to Cachix
        run: |
          # Push the package and all its runtime dependencies
          nix path-info .#btblocker --closure-size --json | jq -r '.[].path' | cachix push btblocker
          echo "Pushed btblocker package to Cachix"

      - name: Show package info
        run: |
          nix path-info .#btblocker
          ls -lh result/bin/

      - name: Test binary runs
        run: |
          ./result/bin/btblocker --help || echo "Help command returned non-zero (expected if no help flag)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: btblocker-nix-${{ github.sha }}
          path: result/bin/btblocker
          retention-days: 30

  test-module:
    name: Test NixOS Module
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: btblocker
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: ${{ github.event_name == 'pull_request' }}

      - name: Evaluate NixOS module
        run: |
          nix eval .#nixosModules.default --apply 'x: "NixOS module loads successfully"'

  dev-shell:
    name: Test Development Shell
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: btblocker
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: ${{ github.event_name == 'pull_request' }}

      - name: Test development shell
        run: |
          nix develop --command bash -c "go version && make build"

  update-flake:
    name: Update Flake Lock
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update flake inputs
        run: |
          nix flake update --commit-lock-file || {
            # If commit-lock-file fails, do it manually
            nix flake update
            if ! git diff --quiet flake.lock; then
              git add flake.lock
              git commit -m "chore: update flake.lock" -m "ðŸ¤– Generated by GitHub Actions"
            fi
          }

      - name: Push changes
        run: |
          git push || echo "No changes to push"
