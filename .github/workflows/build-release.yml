name: Build and Publish Release

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v0.2.1)'
        required: true

permissions:
  contents: write
  packages: write

jobs:
  build-binaries:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux builds
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
          - os: ubuntu-latest
            goos: linux
            goarch: arm

          # Windows builds
          - os: windows-latest
            goos: windows
            goarch: amd64
          - os: windows-latest
            goos: windows
            goarch: arm64

          # macOS builds
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.20'

      - name: Install Linux dependencies (Linux only)
        if: matrix.goos == 'linux' && matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libnetfilter-queue-dev libnfnetlink-dev

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: ${{ matrix.goos == 'linux' && '1' || '0' }}
          VERSION: ${{ steps.version.outputs.version }}
          COMMIT: ${{ github.sha }}
          DATE: ${{ github.event.release.created_at || github.event.head_commit.timestamp }}
        run: |
          # Cross-compilation setup for Linux ARM builds
          if [ "${{ matrix.goos }}" = "linux" ] && [ "${{ matrix.goarch }}" = "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
            export CC=aarch64-linux-gnu-gcc
          elif [ "${{ matrix.goos }}" = "linux" ] && [ "${{ matrix.goarch }}" = "arm" ]; then
            sudo apt-get install -y gcc-arm-linux-gnueabihf
            export CC=arm-linux-gnueabihf-gcc
          fi

          # Build with version information
          BINARY_NAME="btblocker-${{ steps.version.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi

          go build \
            -ldflags="-s -w -X main.Version=$VERSION -X main.Commit=$COMMIT -X main.Date=$DATE" \
            -o "$BINARY_NAME" \
            ./cmd/btblocker

          echo "binary_name=${BINARY_NAME}" >> $GITHUB_OUTPUT
        shell: bash
        id: build

      - name: Create tarball (Unix)
        if: matrix.goos != 'windows'
        run: |
          ARCHIVE_NAME="btblocker-${{ steps.version.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz"
          tar -czf "$ARCHIVE_NAME" "${{ steps.build.outputs.binary_name }}" README.md LICENSE
          echo "archive_name=${ARCHIVE_NAME}" >> $GITHUB_OUTPUT
        shell: bash
        id: tarball_unix

      - name: Create zip (Windows)
        if: matrix.goos == 'windows'
        run: |
          $ARCHIVE_NAME = "btblocker-${{ steps.version.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.zip"
          Compress-Archive -Path "${{ steps.build.outputs.binary_name }}", "README.md", "LICENSE" -DestinationPath "$ARCHIVE_NAME"
          echo "archive_name=$ARCHIVE_NAME" >> $env:GITHUB_OUTPUT
        shell: pwsh
        id: zip_windows

      - name: Generate checksums
        run: |
          if [ "${{ matrix.goos }}" = "windows" ]; then
            ARCHIVE="${{ steps.zip_windows.outputs.archive_name }}"
          else
            ARCHIVE="${{ steps.tarball_unix.outputs.archive_name }}"
          fi
          sha256sum "$ARCHIVE" > "${ARCHIVE}.sha256"
        shell: bash

      - name: Upload to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ matrix.goos }}" = "windows" ]; then
            ARCHIVE="${{ steps.zip_windows.outputs.archive_name }}"
          else
            ARCHIVE="${{ steps.tarball_unix.outputs.archive_name }}"
          fi

          gh release upload "${{ steps.version.outputs.tag }}" \
            "$ARCHIVE" \
            "${ARCHIVE}.sha256" \
            --clobber
        shell: bash

  build-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build-binaries

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/btblocker:${{ steps.version.outputs.tag }}
            ghcr.io/${{ github.repository_owner }}/btblocker:latest
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            COMMIT=${{ github.sha }}
            DATE=${{ github.event.release.created_at || github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: build-binaries
    if: github.event_name == 'release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version and checksums
        id: info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT

          # Download Linux AMD64 tarball checksum
          gh release download "$VERSION" \
            -p "btblocker-*-linux-amd64.tar.gz.sha256"

          SHA256=$(cat btblocker-*-linux-amd64.tar.gz.sha256 | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      - name: Generate Homebrew formula
        run: |
          cat > btblocker.rb << 'EOF'
          class Btblocker < Formula
            desc "High-performance DPI-based BitTorrent traffic blocker"
            homepage "https://github.com/spaiter/BitTorrentBlocker"
            url "https://github.com/spaiter/BitTorrentBlocker/releases/download/${{ steps.info.outputs.tag }}/btblocker-${{ steps.info.outputs.version }}-linux-amd64.tar.gz"
            sha256 "${{ steps.info.outputs.sha256 }}"
            version "${{ steps.info.outputs.version }}"
            license "MIT"

            depends_on "libnetfilter-queue"
            depends_on "libnfnetlink"
            depends_on :linux

            def install
              bin.install "btblocker-${{ steps.info.outputs.version }}-linux-amd64" => "btblocker"
            end

            test do
              system "#{bin}/btblocker", "--help"
            end
          end
          EOF

      - name: Upload Homebrew formula to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ steps.info.outputs.tag }}" \
            btblocker.rb \
            --clobber

  publish-summary:
    name: Publish Summary
    runs-on: ubuntu-latest
    needs: [build-binaries, build-docker, update-homebrew]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## ðŸ“¦ Release Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Published:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Binaries for Linux (amd64, arm64, arm)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Binaries for Windows (amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Binaries for macOS (amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker images (multi-arch)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Homebrew formula" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Nix package (via Cachix)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation Methods:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**GitHub Release:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "curl -LO https://github.com/spaiter/BitTorrentBlocker/releases/latest/download/btblocker-VERSION-OS-ARCH.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/spaiter/btblocker:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Nix:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "nix profile install github:spaiter/BitTorrentBlocker" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
