#!/bin/bash
# Pre-commit hook that runs tests and linting before allowing a commit
# This ensures code quality and prevents breaking changes from being committed

set -e

# Don't prioritize Go bin directory to avoid using outdated golangci-lint
# System-wide installations (chocolatey, etc) should be preferred
# if [ -d "$HOME/go/bin" ]; then
#     export PATH="$HOME/go/bin:$PATH"
# fi

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}âœ“${NC} $2"
    else
        echo -e "${RED}âœ—${NC} $2"
    fi
}

# Track overall status
OVERALL_STATUS=0

# 1. Check formatting (exclude gitignored directories)
echo ""
echo "ðŸ“ Checking code formatting..."
# Handle both Unix (/) and Windows (\) path separators
UNFORMATTED=$(gofmt -l . | grep -v "^vendor" | grep -vE "^nDPI[/\\]" | grep -vE "^suricata[/\\]" | grep -vE "^suricata-verify[/\\]" | grep -vE "^sing-box[/\\]" || true)
if [ -z "$UNFORMATTED" ]; then
    print_status 0 "Code formatting check passed"
else
    print_status 1 "Code formatting check failed"
    echo -e "${YELLOW}Unformatted files:${NC}"
    echo "$UNFORMATTED"
    echo -e "${YELLOW}Run: gofmt -w \$(find . -name '*.go' -not -path './vendor/*' -not -path './nDPI/*' -not -path './suricata/*' -not -path './suricata-verify/*' -not -path './sing-box/*')${NC}"
    OVERALL_STATUS=1
fi

# 2. Run linter
echo ""
echo "ðŸ”Ž Running golangci-lint..."
if command -v golangci-lint &> /dev/null; then
    # Run linter and capture output
    LINT_OUTPUT=$(golangci-lint run --timeout=3m 2>&1)
    LINT_EXIT=$?

    # Check if there are actual issues (not just typechecking errors from excluded dirs)
    if echo "$LINT_OUTPUT" | grep -q "^0 issues"; then
        print_status 0 "Linting passed"
    elif [ $LINT_EXIT -eq 0 ]; then
        print_status 0 "Linting passed"
    else
        echo "$LINT_OUTPUT"
        print_status 1 "Linting failed"
        OVERALL_STATUS=1
    fi
else
    echo -e "${YELLOW}âš  golangci-lint not found, skipping linting${NC}"
    echo -e "${YELLOW}Install from: https://golangci-lint.run/usage/install/${NC}"
fi

# 3. Run tests (without race detector on Windows if CGO is disabled)
echo ""
echo "ðŸ§ª Running tests..."
# Exclude gitignored test directories
TEST_DIRS=$(go list ./... | grep -v "/nDPI/" | grep -v "/suricata/" | grep -v "/suricata-verify/" | grep -v "/sing-box/")
if [ "$CGO_ENABLED" = "0" ] || [ -z "$CGO_ENABLED" ]; then
    # Skip race detector if CGO is disabled (common on Windows)
    if echo "$TEST_DIRS" | xargs go test -timeout=5m; then
        print_status 0 "Tests passed"
    else
        print_status 1 "Tests failed"
        OVERALL_STATUS=1
    fi
else
    if echo "$TEST_DIRS" | xargs go test -race -timeout=5m; then
        print_status 0 "Tests passed (with race detector)"
    else
        print_status 1 "Tests failed"
        OVERALL_STATUS=1
    fi
fi

# 4. Check for common issues
echo ""
echo "ðŸ” Checking for common issues..."

# Check for debugger statements
if git diff --cached --name-only | grep '\.go$' | xargs grep -n "fmt.Println\|spew.Dump" 2>/dev/null; then
    print_status 1 "Found debug statements (fmt.Println, spew.Dump)"
    echo -e "${YELLOW}Consider removing debug statements before committing${NC}"
    OVERALL_STATUS=1
else
    print_status 0 "No debug statements found"
fi

# Check for TODO/FIXME without issue reference
if git diff --cached --name-only | grep '\.go$' | xargs grep -n "TODO\|FIXME" 2>/dev/null | grep -v "#[0-9]"; then
    echo -e "${YELLOW}âš  Found TODO/FIXME without issue reference${NC}"
    echo -e "${YELLOW}Consider linking to an issue (e.g., TODO(#123): ...)${NC}"
fi

# Final status
echo ""
if [ $OVERALL_STATUS -eq 0 ]; then
    echo -e "${GREEN}âœ“ All pre-commit checks passed!${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}âœ— Pre-commit checks failed${NC}"
    echo ""
    echo "To skip these checks (not recommended), use:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi
