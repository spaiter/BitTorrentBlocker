#!/bin/bash
# Pre-commit hook that runs tests and linting before allowing a commit
# This ensures code quality and prevents breaking changes from being committed

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}âœ“${NC} $2"
    else
        echo -e "${RED}âœ—${NC} $2"
    fi
}

# Track overall status
OVERALL_STATUS=0

# 1. Check formatting (exclude vendor directory)
echo ""
echo "ðŸ“ Checking code formatting..."
UNFORMATTED=$(gofmt -l . | grep -v "^vendor" || true)
if [ -z "$UNFORMATTED" ]; then
    print_status 0 "Code formatting check passed"
else
    print_status 1 "Code formatting check failed"
    echo -e "${YELLOW}Unformatted files:${NC}"
    echo "$UNFORMATTED"
    echo -e "${YELLOW}Run: gofmt -w \$(find . -name '*.go' -not -path './vendor/*')${NC}"
    OVERALL_STATUS=1
fi

# 2. Run linter
echo ""
echo "ðŸ”Ž Running golangci-lint..."
if command -v golangci-lint &> /dev/null; then
    if golangci-lint run --timeout=3m; then
        print_status 0 "Linting passed"
    else
        print_status 1 "Linting failed"
        OVERALL_STATUS=1
    fi
else
    echo -e "${YELLOW}âš  golangci-lint not found, skipping linting${NC}"
    echo -e "${YELLOW}Install from: https://golangci-lint.run/usage/install/${NC}"
fi

# 3. Run tests (without race detector on Windows if CGO is disabled)
echo ""
echo "ðŸ§ª Running tests..."
if [ "$CGO_ENABLED" = "0" ] || [ -z "$CGO_ENABLED" ]; then
    # Skip race detector if CGO is disabled (common on Windows)
    if go test ./... -timeout=5m; then
        print_status 0 "Tests passed"
    else
        print_status 1 "Tests failed"
        OVERALL_STATUS=1
    fi
else
    if go test ./... -race -timeout=5m; then
        print_status 0 "Tests passed (with race detector)"
    else
        print_status 1 "Tests failed"
        OVERALL_STATUS=1
    fi
fi

# 4. Check for common issues
echo ""
echo "ðŸ” Checking for common issues..."

# Check for debugger statements
if git diff --cached --name-only | grep '\.go$' | xargs grep -n "fmt.Println\|spew.Dump" 2>/dev/null; then
    print_status 1 "Found debug statements (fmt.Println, spew.Dump)"
    echo -e "${YELLOW}Consider removing debug statements before committing${NC}"
    OVERALL_STATUS=1
else
    print_status 0 "No debug statements found"
fi

# Check for TODO/FIXME without issue reference
if git diff --cached --name-only | grep '\.go$' | xargs grep -n "TODO\|FIXME" 2>/dev/null | grep -v "#[0-9]"; then
    echo -e "${YELLOW}âš  Found TODO/FIXME without issue reference${NC}"
    echo -e "${YELLOW}Consider linking to an issue (e.g., TODO(#123): ...)${NC}"
fi

# Final status
echo ""
if [ $OVERALL_STATUS -eq 0 ]; then
    echo -e "${GREEN}âœ“ All pre-commit checks passed!${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}âœ— Pre-commit checks failed${NC}"
    echo ""
    echo "To skip these checks (not recommended), use:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi
