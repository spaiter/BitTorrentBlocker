#!/bin/bash
# Pre-commit hook that runs tests and linting before allowing a commit
# This ensures code quality and prevents breaking changes from being committed

set -e

# Don't prioritize Go bin directory to avoid using outdated golangci-lint
# System-wide installations (chocolatey, etc) should be preferred
# if [ -d "$HOME/go/bin" ]; then
#     export PATH="$HOME/go/bin:$PATH"
# fi

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}âœ“${NC} $2"
    else
        echo -e "${RED}âœ—${NC} $2"
    fi
}

# Track overall status
OVERALL_STATUS=0

# 1. Check formatting (exclude gitignored directories)
echo ""
echo "ðŸ“ Checking code formatting..."
# Handle both Unix (/) and Windows (\) path separators
UNFORMATTED=$(gofmt -l . | grep -v "^vendor" || true)
if [ -z "$UNFORMATTED" ]; then
    print_status 0 "Code formatting check passed"
else
    print_status 1 "Code formatting check failed"
    echo -e "${YELLOW}Unformatted files:${NC}"
    echo "$UNFORMATTED"
    echo -e "${YELLOW}Run: gofmt -w \$(find . -name '*.go' -not -path './vendor/*')${NC}"
    OVERALL_STATUS=1
fi

# 2. Run linter (only on staged Go files for speed)
echo ""
echo "ðŸ”Ž Running golangci-lint..."
if command -v golangci-lint &> /dev/null; then
    # Get list of staged Go files (excluding gitignored directories)
    STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' | grep -v "^vendor/" || true)

    if [ -n "$STAGED_GO_FILES" ]; then
        # Only lint staged files with reduced timeout (1 minute)
        if echo "$STAGED_GO_FILES" | xargs golangci-lint run --timeout=1m --new-from-rev=HEAD~ 2>&1 | tee /tmp/lint.out | grep -q "^0 issues"; then
            print_status 0 "Linting passed"
        elif [ ${PIPESTATUS[1]} -eq 0 ]; then
            print_status 0 "Linting passed"
        else
            cat /tmp/lint.out
            print_status 1 "Linting failed"
            OVERALL_STATUS=1
        fi
        rm -f /tmp/lint.out
    else
        echo -e "${YELLOW}âš  No staged Go files to lint${NC}"
    fi
else
    echo -e "${YELLOW}âš  golangci-lint not found, skipping linting${NC}"
    echo -e "${YELLOW}Install from: https://golangci-lint.run/usage/install/${NC}"
fi

# 3. Run tests (without race detector on Windows if CGO is disabled)
echo ""
echo "ðŸ§ª Running tests..."
# Get all test directories (vendor is automatically excluded by go list)
TEST_DIRS=$(go list ./...)
if [ "$CGO_ENABLED" = "0" ] || [ -z "$CGO_ENABLED" ]; then
    # Skip race detector if CGO is disabled (common on Windows)
    if echo "$TEST_DIRS" | xargs go test -timeout=5m; then
        print_status 0 "Tests passed"
    else
        print_status 1 "Tests failed"
        OVERALL_STATUS=1
    fi
else
    if echo "$TEST_DIRS" | xargs go test -race -timeout=5m; then
        print_status 0 "Tests passed (with race detector)"
    else
        print_status 1 "Tests failed"
        OVERALL_STATUS=1
    fi
fi

# 4. Check for common issues
echo ""
echo "ðŸ” Checking for common issues..."

# Check for debugger statements
if git diff --cached --name-only | grep '\.go$' | xargs grep -n "fmt.Println\|spew.Dump" 2>/dev/null; then
    print_status 1 "Found debug statements (fmt.Println, spew.Dump)"
    echo -e "${YELLOW}Consider removing debug statements before committing${NC}"
    OVERALL_STATUS=1
else
    print_status 0 "No debug statements found"
fi

# Check for TODO/FIXME without issue reference
if git diff --cached --name-only | grep '\.go$' | xargs grep -n "TODO\|FIXME" 2>/dev/null | grep -v "#[0-9]"; then
    echo -e "${YELLOW}âš  Found TODO/FIXME without issue reference${NC}"
    echo -e "${YELLOW}Consider linking to an issue (e.g., TODO(#123): ...)${NC}"
fi

# Final status
echo ""
if [ $OVERALL_STATUS -eq 0 ]; then
    echo -e "${GREEN}âœ“ All pre-commit checks passed!${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}âœ— Pre-commit checks failed${NC}"
    echo ""
    echo "To skip these checks (not recommended), use:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi
