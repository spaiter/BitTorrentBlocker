#!/bin/bash
# Pre-commit hook that runs tests and linting before allowing a commit
# This ensures code quality and prevents breaking changes from being committed

set -e

# Prioritize Go bin directory for latest golangci-lint v2.7.2
if [ -d "$HOME/go/bin" ]; then
    export PATH="$HOME/go/bin:$PATH"
fi

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}âœ“${NC} $2"
    else
        echo -e "${RED}âœ—${NC} $2"
    fi
}

# Track overall status
OVERALL_STATUS=0

# 1. Auto-format code (exclude gitignored directories)
echo ""
echo "ðŸ“ Auto-formatting code..."
# Handle both Unix (/) and Windows (\) path separators
UNFORMATTED=$(gofmt -l . | grep -v "^vendor" || true)
if [ -z "$UNFORMATTED" ]; then
    print_status 0 "Code is already formatted"
else
    echo -e "${YELLOW}Formatting files:${NC}"
    echo "$UNFORMATTED"

    # Auto-format the files
    find . -name '*.go' -not -path './vendor/*' -exec gofmt -w {} \;

    # Re-stage the formatted files
    git add -A

    print_status 0 "Code auto-formatted and re-staged"
fi

# 2. Run golangci-lint with auto-fix (full codebase check like CI)
echo ""
echo "ðŸ”Ž Running golangci-lint with auto-fix..."
if command -v golangci-lint &> /dev/null; then
    # Run linter on entire codebase with --fix flag (matches GitHub Actions behavior)
    if golangci-lint run --fix --timeout=5m ./... 2>&1 | tee /tmp/lint.out; then
        # Check if there were any auto-fixes applied
        if git diff --quiet; then
            # No changes from linter fixes
            print_status 0 "Linting passed"
        else
            # Linter applied fixes, re-stage them
            git add -A
            print_status 0 "Linting issues auto-fixed and re-staged"
        fi
    else
        # Linter failed with unfixable issues
        cat /tmp/lint.out
        print_status 1 "Linting failed (manual fixes required)"
        OVERALL_STATUS=1
    fi
    rm -f /tmp/lint.out
else
    echo -e "${YELLOW}âš  golangci-lint not found, skipping linting${NC}"
    echo -e "${YELLOW}Install from: https://golangci-lint.run/usage/install/${NC}"
fi

# 3. Auto-update Nix vendorHash when Go dependencies change
echo ""
echo "ðŸ”„ Checking for Go dependency changes..."
if git diff --cached --name-only | grep -qE '^(go.mod|go.sum)$'; then
    if command -v nix &> /dev/null && [ -f "flake.nix" ]; then
        echo -e "${YELLOW}Go dependencies changed, recalculating Nix vendorHash...${NC}"

        # Try to build and capture the hash mismatch error
        # The error message contains the correct hash we need
        BUILD_OUTPUT=$(nix build .#btblocker --no-link 2>&1 || true)

        # Extract the "got:" hash from the error message
        NEW_HASH=$(echo "$BUILD_OUTPUT" | grep -oP 'got:\s+\K[a-zA-Z0-9:+/=-]+' | head -1)

        if [ -n "$NEW_HASH" ]; then
            # Get the current hash from flake.nix
            CURRENT_HASH=$(grep -oP 'vendorHash = "\K[^"]+' flake.nix)

            if [ "$NEW_HASH" != "$CURRENT_HASH" ]; then
                echo -e "${YELLOW}Updating vendorHash in flake.nix...${NC}"
                echo "  Old: $CURRENT_HASH"
                echo "  New: $NEW_HASH"

                # Update the hash in flake.nix
                sed -i "s|vendorHash = \"$CURRENT_HASH\"|vendorHash = \"$NEW_HASH\"|" flake.nix

                # Re-stage flake.nix
                git add flake.nix

                print_status 0 "Nix vendorHash updated and re-staged"
            else
                print_status 0 "Nix vendorHash is already up to date"
            fi
        else
            # No hash mismatch means it's already correct or build succeeded
            if echo "$BUILD_OUTPUT" | grep -q "hash mismatch"; then
                print_status 1 "Failed to extract new vendorHash from Nix build output"
                echo "$BUILD_OUTPUT"
                OVERALL_STATUS=1
            else
                print_status 0 "Nix build succeeded, vendorHash is correct"
            fi
        fi
    else
        echo -e "${YELLOW}âš  Nix not found or flake.nix missing, skipping vendorHash update${NC}"
        echo -e "${YELLOW}Install Nix from: https://nixos.org/download.html${NC}"
    fi
else
    echo -e "${YELLOW}âš  No Go dependency changes detected${NC}"
fi

# 4. Run unit tests (without race detector on Windows if CGO is disabled)
echo ""
echo "ðŸ§ª Running unit tests..."
# Get all test directories (vendor is automatically excluded by go list)
TEST_DIRS=$(go list ./...)
if [ "$CGO_ENABLED" = "0" ] || [ -z "$CGO_ENABLED" ]; then
    # Skip race detector if CGO is disabled (common on Windows)
    if echo "$TEST_DIRS" | xargs go test -timeout=5m; then
        print_status 0 "Unit tests passed"
    else
        print_status 1 "Unit tests failed"
        OVERALL_STATUS=1
    fi
else
    if echo "$TEST_DIRS" | xargs go test -race -timeout=5m; then
        print_status 0 "Unit tests passed (with race detector)"
    else
        print_status 1 "Unit tests failed"
        OVERALL_STATUS=1
    fi
fi

# 5. Run integration tests (excluding XDP tests which require privileges)
echo ""
echo "ðŸ”¬ Running integration tests (excluding XDP)..."
if go test -tags=integration -skip='TestXDP' ./test/integration -timeout=30s -v 2>&1 | tee /tmp/integration.out; then
    print_status 0 "Integration tests passed"
else
    print_status 1 "Integration tests failed"
    cat /tmp/integration.out
    OVERALL_STATUS=1
fi
rm -f /tmp/integration.out

# 6. Check for common issues
echo ""
echo "ðŸ” Checking for common issues..."

# Check for debugger statements
if git diff --cached --name-only | grep '\.go$' | xargs grep -n "fmt.Println\|spew.Dump" 2>/dev/null; then
    print_status 1 "Found debug statements (fmt.Println, spew.Dump)"
    echo -e "${YELLOW}Consider removing debug statements before committing${NC}"
    OVERALL_STATUS=1
else
    print_status 0 "No debug statements found"
fi

# Check for TODO/FIXME without issue reference
if git diff --cached --name-only | grep '\.go$' | xargs grep -n "TODO\|FIXME" 2>/dev/null | grep -v "#[0-9]"; then
    echo -e "${YELLOW}âš  Found TODO/FIXME without issue reference${NC}"
    echo -e "${YELLOW}Consider linking to an issue (e.g., TODO(#123): ...)${NC}"
fi

# Final status
echo ""
if [ $OVERALL_STATUS -eq 0 ]; then
    echo -e "${GREEN}âœ“ All pre-commit checks passed!${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}âœ— Pre-commit checks failed${NC}"
    echo ""
    echo "To skip these checks (not recommended), use:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi
